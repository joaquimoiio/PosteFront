<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque Consolidado - Jefferson</title>
    <link rel="stylesheet" href="css/universal.css">
    <script src="js/utils.js"></script>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <h1>üì¶ Estoque Consolidado</h1>
            <p>Gest√£o Unificada dos Dois Caminh√µes</p>
        </div>
    </header>

    <nav class="main-nav">
        <div class="nav-container jefferson">
            <a href="dashboard-jefferson.html" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="estoque-consolidado.html" class="nav-item active">
                <span class="nav-icon">üì¶</span>
                <span>Estoque Geral</span>
            </a>
            <a href="estoque-vermelho.html" class="nav-item">
                <span class="nav-icon">üöõ</span>
                <span>Est. Vermelho</span>
            </a>
            <a href="estoque-branco.html" class="nav-item">
                <span class="nav-icon">üöö</span>
                <span>Est. Branco</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <section class="form-section">
            <h2>‚ûï Adicionar Estoque</h2>
            <form id="estoque-form">
                <div class="form-group">
                    <label for="estoque-caminhao">Caminh√£o *</label>
                    <select id="estoque-caminhao" required>
                        <option value="">Selecione o caminh√£o</option>
                        <option value="vermelho">üöõ Caminh√£o Vermelho</option>
                        <option value="branco">üöö Caminh√£o Branco</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="estoque-poste">Poste *</label>
                    <select id="estoque-poste" required>
                        <option value="">Primeiro selecione o caminh√£o</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="estoque-quantidade">Quantidade *</label>
                    <input type="number" id="estoque-quantidade" required placeholder="Ex: 10" min="1">
                </div>

                <div class="form-group">
                    <label for="estoque-observacao">Observa√ß√£o</label>
                    <input type="text" id="estoque-observacao" placeholder="Ex: Compra, devolu√ß√£o..." maxlength="255">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        üì¶ Adicionar ao Estoque
                    </button>
                    <button type="reset" class="btn btn-secondary">
                        üîÑ Limpar
                    </button>
                </div>
            </form>
        </section>

        <section class="summary-section">
            <h2>üìä Resumo Consolidado</h2>
            <div class="stats-grid">
                <div class="stat-item total">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-number" id="total-tipos">0</div>
                    <div class="stat-label">Tipos de Postes</div>
                </div>
                <div class="stat-item positivo">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-number" id="estoque-positivo">0</div>
                    <div class="stat-label">Estoque Positivo</div>
                </div>
                <div class="stat-item negativo">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-number" id="estoque-negativo">0</div>
                    <div class="stat-label">Estoque Negativo</div>
                </div>
                <div class="stat-item zero">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-number" id="estoque-zero">0</div>
                    <div class="stat-label">Estoque Zero</div>
                </div>
            </div>
        </section>

        <section class="filter-section">
            <h2>üîç Filtros</h2>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="filtro-caminhao">Caminh√£o</label>
                    <select id="filtro-caminhao">
                        <option value="">Todos os caminh√µes</option>
                        <option value="vermelho">üöõ Vermelho</option>
                        <option value="branco">üöö Branco</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filtro-status">Status do Estoque</label>
                    <select id="filtro-status">
                        <option value="">Todos os status</option>
                        <option value="positivo">‚úÖ Positivo (> 0)</option>
                        <option value="zero">üì¶ Zero (= 0)</option>
                        <option value="negativo">üîª Negativo (< 0)</option>
                        <option value="baixo">‚ö†Ô∏è Baixo (<= 5)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filtro-codigo">C√≥digo</label>
                    <input type="text" id="filtro-codigo" placeholder="Buscar c√≥digo...">
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="aplicarFiltros()">
                        üîç Filtrar
                    </button>
                    <button class="btn btn-secondary" onclick="limparFiltros()">
                        üßπ Limpar
                    </button>
                </div>
            </div>
        </section>

        <section class="table-section">
            <div class="section-header">
                <h2>üì¶ Estoque Consolidado Completo</h2>
                <div class="section-actions">
                    <button class="btn btn-small" onclick="atualizarEstoque()">
                        üîÑ Atualizar
                    </button>
                    <button class="btn btn-small" onclick="exportarEstoque()">
                        üìä Exportar
                    </button>
                </div>
            </div>

            <div class="table-container">
                <div id="estoque-list" class="mobile-list">
                    <!-- Conte√∫do ser√° carregado dinamicamente -->
                </div>
            </div>
        </section>
    </main>

    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>Carregando dados...</p>
    </div>

    <div id="alert-container" class="alert-container"></div>

    <script>
        // Estado local do Jefferson para estoque consolidado
        let estoqueData = {
            estoqueVermelho: [],
            estoqueBranco: [],
            estoqueConsolidado: [],
            postesVermelho: [],
            postesBranco: [],
            filters: { caminhao: '', status: '', codigo: '' }
        };

        // Verificar autentica√ß√£o espec√≠fica do Jefferson
        document.addEventListener('DOMContentLoaded', () => {
            const userType = localStorage.getItem('poste-system-user-type');
            if (userType !== 'jefferson') {
                window.location.href = 'index.html';
                return;
            }

            if (!window.AppUtils) {
                console.error('AppUtils n√£o carregado! Verifique se utils.js foi inclu√≠do.');
                return;
            }
            
            initEstoqueConsolidado();
        });

        async function initEstoqueConsolidado() {
            console.log('üéØ Inicializando Estoque Consolidado...');
            
            try {
                setupEventListeners();
                await loadAllData();
                console.log('‚úÖ Estoque Consolidado carregado');
            } catch (error) {
                console.error('‚ùå Erro ao carregar:', error);
                window.AppUtils.showAlert('Erro ao carregar dados. Verifique sua conex√£o.', 'error');
            }
        }

        function setupEventListeners() {
            // Form principal
            const estoqueForm = document.getElementById('estoque-form');
            if (estoqueForm) {
                estoqueForm.addEventListener('submit', handleEstoqueSubmit);
                estoqueForm.addEventListener('reset', resetForm);
            }

            // Mudan√ßa de caminh√£o atualiza postes
            const caminhaoSelect = document.getElementById('estoque-caminhao');
            if (caminhaoSelect) {
                caminhaoSelect.addEventListener('change', handleCaminhaoChange);
            }

            // Filtros
            const filtros = ['filtro-caminhao', 'filtro-status', 'filtro-codigo'];
            filtros.forEach(filtroId => {
                const elemento = document.getElementById(filtroId);
                if (elemento) {
                    elemento.addEventListener('change', aplicarFiltros);
                    elemento.addEventListener('input', aplicarFiltros);
                }
            });
        }

        async function loadAllData() {
            try {
                window.AppUtils.showLoading(true);
                
                console.log('üìä Carregando dados dos dois caminh√µes...');
                
                // Carregar dados dos dois caminh√µes
                const [estoqueVermelho, estoqueBranco, postesVermelho, postesBranco] = await Promise.all([
                    fetchEstoqueCaminhao('vermelho'),
                    fetchEstoqueCaminhao('branco'),
                    fetchPostesCaminhao('vermelho'),
                    fetchPostesCaminhao('branco')
                ]);

                estoqueData.estoqueVermelho = estoqueVermelho || [];
                estoqueData.estoqueBranco = estoqueBranco || [];
                estoqueData.postesVermelho = postesVermelho || [];
                estoqueData.postesBranco = postesBranco || [];
                
                // Consolidar estoques
                estoqueData.estoqueConsolidado = consolidarEstoques(
                    estoqueData.estoqueVermelho, 
                    estoqueData.estoqueBranco
                );

                populatePosteSelect();
                updateResumo();
                aplicarFiltros();
                
                console.log('‚úÖ Dados consolidados carregados');
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                throw error;
            } finally {
                window.AppUtils.showLoading(false);
            }
        }

        async function fetchEstoqueCaminhao(caminhao) {
            try {
                const response = await fetch(`https://posteback.onrender.com/api/estoque?caminhao=${caminhao}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': caminhao
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`Erro ao buscar estoque do ${caminhao}:`, error);
                return [];
            }
        }

        async function fetchPostesCaminhao(caminhao) {
            try {
                const response = await fetch(`https://posteback.onrender.com/api/postes?caminhao=${caminhao}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': caminhao
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const postes = await response.json();
                return (postes || []).filter(p => p.ativo);
            } catch (error) {
                console.error(`Erro ao buscar postes do ${caminhao}:`, error);
                return [];
            }
        }

        function consolidarEstoques(estoqueVermelho, estoqueBranco) {
            const consolidado = [];
            const processados = new Set();

            // Processar estoque vermelho
            estoqueVermelho.forEach(item => {
                const chave = item.codigoPoste;
                consolidado.push({
                    ...item,
                    caminhao: 'vermelho',
                    quantidadeVermelho: item.quantidadeAtual || 0,
                    quantidadeBranco: 0,
                    quantidadeTotal: item.quantidadeAtual || 0
                });
                processados.add(chave);
            });

            // Processar estoque branco
            estoqueBranco.forEach(item => {
                const chave = item.codigoPoste;
                const existente = consolidado.find(c => c.codigoPoste === chave);
                
                if (existente) {
                    // Item j√° existe, somar quantidades
                    existente.quantidadeBranco = item.quantidadeAtual || 0;
                    existente.quantidadeTotal = existente.quantidadeVermelho + existente.quantidadeBranco;
                    existente.caminhao = 'ambos';
                } else {
                    // Item novo apenas no branco
                    consolidado.push({
                        ...item,
                        caminhao: 'branco',
                        quantidadeVermelho: 0,
                        quantidadeBranco: item.quantidadeAtual || 0,
                        quantidadeTotal: item.quantidadeAtual || 0
                    });
                }
            });

            return consolidado.sort((a, b) => a.codigoPoste.localeCompare(b.codigoPoste));
        }

        function populatePosteSelect() {
            const caminhaoSelect = document.getElementById('estoque-caminhao');
            const posteSelect = document.getElementById('estoque-poste');
            
            if (!caminhaoSelect || !posteSelect) return;
            
            // Limpar op√ß√µes existentes exceto a primeira
            while (posteSelect.children.length > 1) {
                posteSelect.removeChild(posteSelect.lastChild);
            }
            
            const caminhao = caminhaoSelect.value;
            if (!caminhao) {
                posteSelect.innerHTML = '<option value="">Primeiro selecione o caminh√£o</option>';
                return;
            }
            
            const postes = caminhao === 'vermelho' ? estoqueData.postesVermelho : estoqueData.postesBranco;
            
            posteSelect.innerHTML = '<option value="">Selecione um poste</option>';
            postes.forEach(poste => {
                const option = document.createElement('option');
                option.value = poste.id;
                option.textContent = `${poste.codigo} - ${poste.descricao} (${window.AppUtils.formatCurrency(poste.preco)})`;
                posteSelect.appendChild(option);
            });
        }

        function handleCaminhaoChange() {
            populatePosteSelect();
        }

        async function handleEstoqueSubmit(e) {
            e.preventDefault();
            
            try {
                const formData = buildFormData();
                
                if (!validateFormData(formData)) {
                    return;
                }
                
                window.AppUtils.showLoading(true);
                
                // Fazer requisi√ß√£o para o caminh√£o espec√≠fico
                const response = await fetch('https://posteback.onrender.com/api/estoque/adicionar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': formData.caminhao
                    },
                    body: JSON.stringify({
                        posteId: formData.posteId,
                        quantidade: formData.quantidade
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                window.AppUtils.showAlert('Estoque adicionado com sucesso!', 'success');
                resetForm();
                
                await loadAllData();
                
            } catch (error) {
                console.error('Erro ao adicionar estoque:', error);
                window.AppUtils.showAlert('Erro ao adicionar estoque: ' + error.message, 'error');
            } finally {
                window.AppUtils.showLoading(false);
            }
        }

        function buildFormData() {
            return {
                caminhao: document.getElementById('estoque-caminhao').value,
                posteId: parseInt(document.getElementById('estoque-poste').value),
                quantidade: parseInt(document.getElementById('estoque-quantidade').value),
                observacao: document.getElementById('estoque-observacao').value.trim() || null
            };
        }

        function validateFormData(data) {
            if (!window.AppUtils.validateRequired(data.caminhao, 'Caminh√£o') ||
                !window.AppUtils.validateRequired(data.posteId, 'Poste')) {
                return false;
            }
            
            return window.AppUtils.validateNumber(data.quantidade, 'Quantidade', 0);
        }

        function updateResumo() {
            const total = estoqueData.estoqueConsolidado.length;
            const positivo = estoqueData.estoqueConsolidado.filter(item => item.quantidadeTotal > 0).length;
            const zero = estoqueData.estoqueConsolidado.filter(item => item.quantidadeTotal === 0).length;
            const negativo = estoqueData.estoqueConsolidado.filter(item => item.quantidadeTotal < 0).length;
            
            window.AppUtils.updateElement('total-tipos', total);
            window.AppUtils.updateElement('estoque-positivo', positivo);
            window.AppUtils.updateElement('estoque-negativo', negativo);
            window.AppUtils.updateElement('estoque-zero', zero);
        }

        function aplicarFiltros() {
            const caminhao = document.getElementById('filtro-caminhao').value;
            const status = document.getElementById('filtro-status').value;
            const codigo = document.getElementById('filtro-codigo').value.toLowerCase();

            let filtrados = [...estoqueData.estoqueConsolidado];

            // Filtrar por caminh√£o
            if (caminhao) {
                filtrados = filtrados.filter(item => {
                    if (caminhao === 'vermelho') {
                        return item.quantidadeVermelho > 0;
                    } else if (caminhao === 'branco') {
                        return item.quantidadeBranco > 0;
                    }
                    return true;
                });
            }

            // Filtrar por status
            if (status) {
                filtrados = filtrados.filter(item => {
                    const qtd = item.quantidadeTotal;
                    switch (status) {
                        case 'positivo': return qtd > 0;
                        case 'zero': return qtd === 0;
                        case 'negativo': return qtd < 0;
                        case 'baixo': return qtd > 0 && qtd <= 5;
                        default: return true;
                    }
                });
            }

            // Filtrar por c√≥digo
            if (codigo) {
                filtrados = filtrados.filter(item => 
                    item.codigoPoste.toLowerCase().includes(codigo) ||
                    item.descricaoPoste.toLowerCase().includes(codigo)
                );
            }

            displayEstoque(filtrados);
        }

        function displayEstoque(estoque) {
            const container = document.getElementById('estoque-list');
            if (!container) return;
            
            if (!estoque || estoque.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <h3>Nenhum item encontrado</h3>
                        <p>Ajuste os filtros para ver mais itens.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            estoque.forEach(item => {
                const element = createEstoqueItem(item);
                container.appendChild(element);
            });
        }

        function createEstoqueItem(item) {
            const element = document.createElement('div');
            const statusClass = getStatusClass(item.quantidadeTotal);
            
            element.className = `mobile-list-item ${statusClass}`;
            
            // √çcones dos caminh√µes
            let caminhaoInfo = '';
            if (item.quantidadeVermelho > 0 && item.quantidadeBranco > 0) {
                caminhaoInfo = `üöõ ${item.quantidadeVermelho} | üöö ${item.quantidadeBranco}`;
            } else if (item.quantidadeVermelho > 0) {
                caminhaoInfo = `üöõ ${item.quantidadeVermelho}`;
            } else if (item.quantidadeBranco > 0) {
                caminhaoInfo = `üöö ${item.quantidadeBranco}`;
            } else {
                caminhaoInfo = 'üì¶ Esgotado';
            }
            
            element.innerHTML = `
                <div class="item-header">
                    <span class="item-status ${statusClass}">
                        ${getStatusText(item.quantidadeTotal)}
                    </span>
                    <span class="item-code">${item.codigoPoste}</span>
                </div>
                
                <div class="item-content">
                    <div class="item-quantidade ${statusClass}">${item.quantidadeTotal}</div>
                    <div class="item-title">${item.descricaoPoste}</div>
                    <div class="item-details">
                        <small style="color: var(--text-secondary);">${caminhaoInfo}</small>
                    </div>
                    <div class="item-details">Pre√ßo: ${window.AppUtils.formatCurrency(item.precoPoste || 0)}</div>
                </div>
            `;
            
            return element;
        }

        function getStatusClass(quantidade) {
            if (quantidade > 5) return 'positivo';
            if (quantidade > 0) return 'baixo';
            if (quantidade === 0) return 'zero';
            return 'negativo';
        }

        function getStatusText(quantidade) {
            if (quantidade > 5) return '‚úÖ Dispon√≠vel';
            if (quantidade > 0) return '‚ö†Ô∏è Baixo';
            if (quantidade === 0) return 'üì¶ Esgotado';
            return 'üîª Negativo';
        }

        function resetForm() {
            document.getElementById('estoque-form').reset();
            populatePosteSelect();
        }

        function limparFiltros() {
            document.getElementById('filtro-caminhao').value = '';
            document.getElementById('filtro-status').value = '';
            document.getElementById('filtro-codigo').value = '';
            aplicarFiltros();
            window.AppUtils.showAlert('Filtros limpos', 'success');
        }

        async function atualizarEstoque() {
            try {
                await loadAllData();
                window.AppUtils.showAlert('Estoque atualizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao atualizar estoque:', error);
                window.AppUtils.showAlert('Erro ao atualizar. Verifique sua conex√£o.', 'error');
            }
        }

        function exportarEstoque() {
            if (!estoqueData.estoqueConsolidado || estoqueData.estoqueConsolidado.length === 0) {
                window.AppUtils.showAlert('Nenhum estoque para exportar', 'warning');
                return;
            }
            
            const dadosExportar = estoqueData.estoqueConsolidado.map(item => ({
                'C√≥digo': item.codigoPoste,
                'Descri√ß√£o': item.descricaoPoste,
                'Pre√ßo': item.precoPoste || 0,
                'Qtd. Vermelho': item.quantidadeVermelho,
                'Qtd. Branco': item.quantidadeBranco,
                'Qtd. Total': item.quantidadeTotal,
                'Status': getStatusText(item.quantidadeTotal),
                'Valor Total': (item.quantidadeTotal * (item.precoPoste || 0)).toFixed(2)
            }));
            
            window.AppUtils.exportToCSV(dadosExportar, `estoque_consolidado_${new Date().toISOString().split('T')[0]}`);
        }

        // Disponibilizar fun√ß√µes globalmente
        window.aplicarFiltros = aplicarFiltros;
        window.limparFiltros = limparFiltros;
        window.atualizarEstoque = atualizarEstoque;
        window.exportarEstoque = exportarEstoque;

        console.log('‚úÖ Estoque Consolidado COMPLETO carregado');
    </script>
</body>
</html>